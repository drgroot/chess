stages:
  - test
  - deploy

services:
  - docker:dind
cache:
  key: ${CI_COMMIT_REF_SLUG}

# Javascript tasks
lint:
  stage: test
  image: node:14-alpine
  variables:
    STAGE: lint
  before_script:
    - apk add python make g++ python3
  script:
    - ./cicd/taskbuilder.py web services/node
    - ./tasks.sh
test:
  stage: test
  image: docker:stable
  variables:
    STAGE: test
    MONGODB: mongodb://docker
    RABBITMQ: amqp://docker/
  before_script:
    - apk add python2 make g++ python3 nodejs npm
  script:
    - ./cicd/taskbuilder.py web services/node
    - ./tasks.sh
build:
  image: docker:stable
  variables:
    DOCKER_DRIVER: overlay2
  stage: test
  variables:
    STAGE: build
  before_script:
    - apk add python2 make g++ python3 nodejs npm
    - if [ ! -z $DOCKER_PASSWORD ]; then docker login --username yusufali -p $DOCKER_PASSWORD; fi
  script:
    - ./cicd/taskbuilder.py web services/node
    - ./tasks.sh

# terraform
deploy_images:
  stage: deploy
  image: docker
  before_script:
    - cd deployment
    - apk add bash unzip wget gnupg curl
    - wget https://releases.hashicorp.com/terraform/0.12.25/terraform_0.12.25_linux_amd64.zip
    - unzip *.zip
    - chmod +x terraform
    - mv terraform /bin/.
    - for f in secrets/*.gpg; do echo $SECRET_PASSPHRASE | gpg -d --batch --yes --passphrase-fd 0 "$f" > "secrets/$(basename $f .gpg)"; done
    - source secrets/env
    - tar xzvf secrets/kube.tar.gz -C secrets/
    - terraform init
  script:
    - terraform plan
    - if [ "$CI_COMMIT_REF_NAME" = "master" ]; then terraform apply -auto-approve || true; fi